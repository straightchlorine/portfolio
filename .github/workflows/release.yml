name: Release - Build, Push, and Deploy

# Trigger on version tags (v1.2.3, v2.0.0, etc.)
on:
  push:
    tags:
      - 'v*.*.*'

env:
  K8S_NAMESPACE: portfolio
  DEPLOYMENT_NAME: portfolio-nextjs
  CONTAINER_NAME: nextjs

jobs:
  # ============================================
  # Job 1: Extract version and validate
  # ============================================
  validate:
    runs-on: portfolio-runners
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_without_v: ${{ steps.version.outputs.version_without_v }}

    steps:
      - uses: actions/checkout@v5

      - name: Extract version from tag
        id: version
        run: |
          # Get tag name (e.g., v1.2.3)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Remove 'v' prefix (e.g., 1.2.3)
          VERSION_NO_V=${VERSION#v}
          echo "version_without_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Detected version: $VERSION"

      - name: Validate semantic version
        run: |
          VERSION=${{ steps.version.outputs.version_without_v }}

          # Validate format: MAJOR.MINOR.PATCH
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.2.3 (MAJOR.MINOR.PATCH)"
            exit 1
          fi

          echo "âœ… Version format valid: $VERSION"

  # ============================================
  # Job 2: Run tests before building
  # ============================================
  test:
    needs: validate
    runs-on: portfolio-runners

    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Run type checking
        run: pnpm tsc --noEmit

      - name: Build application
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true

  # ============================================
  # Job 3: Build and push to multiple registries
  # ============================================
  build-and-push:
    needs: [validate, test]
    runs-on: portfolio-runners

    outputs:
      docker-hub-image: ${{ steps.images.outputs.dockerhub }}
      ghcr-image: ${{ steps.images.outputs.ghcr }}

    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Login to GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate image names and tags
      - name: Generate image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/portfolio
            ghcr.io/${{ github.repository }}
          tags: |
            # Version tags (e.g., v1.2.3, 1.2.3)
            type=semver,pattern={{version}}
            type=semver,pattern=v{{version}}
            # Major.Minor (e.g., 1.2)
            type=semver,pattern={{major}}.{{minor}}
            # Major only (e.g., 1)
            type=semver,pattern={{major}}
            # Latest tag (only for default branch releases)
            type=raw,value=latest
            # Git SHA for traceability
            type=sha,prefix={{branch}}-,format=short

      - name: Store image references
        id: images
        run: |
          echo "dockerhub=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/portfolio:${{ needs.validate.outputs.version }}" >> $GITHUB_OUTPUT
          echo "ghcr=ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}" >> $GITHUB_OUTPUT

      # Build and push to both registries
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}

      - name: ðŸ“¦ Image build summary
        run: |
          echo "### ðŸŽ‰ Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Hub:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/portfolio:${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub Container Registry:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 4: Deploy to Kubernetes
  # ============================================
  deploy:
    needs: [validate, build-and-push]
    runs-on: portfolio-runners
    environment:
      name: production
      url: https://portfolio.codextechnologies.org

    steps:
      - uses: actions/checkout@v5

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Update deployment with new image
        run: |
          # Use GHCR as primary (better rate limits)
          IMAGE="ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}"

          echo "ðŸš€ Deploying image: $IMAGE"

          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.CONTAINER_NAME }}=$IMAGE \
            -n ${{ env.K8S_NAMESPACE }}

          # Annotate deployment with version info
          kubectl annotate deployment/${{ env.DEPLOYMENT_NAME }} \
            kubernetes.io/change-cause="Deploy version ${{ needs.validate.outputs.version }} ($(date +%Y-%m-%d\ %H:%M:%S))" \
            -n ${{ env.K8S_NAMESPACE }} \
            --overwrite

      - name: Wait for rollout to complete
        run: |
          echo "â³ Waiting for rollout..."
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=10m

      - name: Verify deployment health
        run: |
          echo "ðŸ” Verifying deployment..."
          echo ""
          echo "Running pods:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=portfolio-nextjs -o wide

          # Show deployment details
          kubectl describe deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }}

          echo "âœ… Deployment successful!"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."

          # Get service endpoint (in production, use your domain)
          ENDPOINT="https://portfolio.codextechnologies.org"

          # Test homepage
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $ENDPOINT)
          if [ $HTTP_CODE -eq 200 ]; then
            echo "âœ… Homepage check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Homepage check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Test health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $ENDPOINT/api/health)
          if [ $HTTP_CODE -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: ðŸŽ‰ Deployment summary
        run: |
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://portfolio.codextechnologies.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed image:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollout history:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl rollout history deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.K8S_NAMESPACE }}
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 5: Create GitHub Release
  # ============================================
  create-release:
    needs: [validate, deploy]
    runs-on: portfolio-runners
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # First release
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            # Compare with previous tag
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Save to file for multi-line output
          echo "$COMMITS" > changelog.txt

          echo "Generated changelog from $PREVIOUS_TAG to ${{ needs.validate.outputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
